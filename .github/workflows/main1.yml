name: Windows Safe Mode (RDP + OBS)

on: 
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'Paste WINDOWS Command (starts with "C:\Program Files...")'
        required: true
      pin:
        description: 'Set a 6-digit PIN'
        required: true
        default: '123456'

jobs:
  windows-safe:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: üõ°Ô∏è Validate Input Code (Prevent Crash)
        shell: powershell
        run: |
          $code = "${{ github.event.inputs.crd_code }}"
          if ($code -match "DISPLAY=") {
            Write-Error "‚ùå WRONG CODE DETECTED! You pasted the Linux code. Please use the Windows (CMD) code from Google."
            exit 1
          }
          if (-not ($code -match "remoting_start_host.exe")) {
            Write-Warning "‚ö†Ô∏è Code looks suspicious. Make sure you copied the Windows (CMD) command."
          }
          Write-Host "‚úÖ Code looks valid. Proceeding..."

      - name: ‚¨áÔ∏è Download Chrome Remote Desktop
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "chromeremotedesktophost.msi"

      - name: üíø Install Chrome Remote Desktop
        run: |
          Start-Process "msiexec.exe" -ArgumentList "/i chromeremotedesktophost.msi /quiet /norestart" -Wait

      - name: üé• Install OBS Studio
        run: |
          choco install obs-studio -y --no-progress
          # Create Desktop Shortcut
          $WshShell = New-Object -comObject WScript.Shell
          $Shortcut = $WshShell.CreateShortcut("$Home\Desktop\OBS Studio.lnk")
          $Shortcut.TargetPath = "C:\Program Files\obs-studio\bin\64bit\obs64.exe"
          $Shortcut.Save()

      - name: üîä Enable Audio
        run: |
          Set-Service -Name Audiosrv -StartupType Automatic
          Start-Service -Name Audiosrv
          Set-Service -Name AudioEndpointBuilder -StartupType Automatic
          Start-Service -Name AudioEndpointBuilder

      - name: üöÄ START GOOGLE REMOTE DESKTOP
        shell: cmd
        run: |
          :: Run the code you pasted
          ${{ github.event.inputs.crd_code }} --pin=${{ github.event.inputs.pin }}

      - name: üì° Verify Connection
        shell: powershell
        run: |
          # Check if the Google service is actually running
          $service = Get-Service "chromoting" -ErrorAction SilentlyContinue
          if ($service.Status -ne 'Running') {
             Write-Error "‚ùå CRITICAL ERROR: The Remote Desktop Service failed to start. Your code might be expired. Generate a new code and try again."
             exit 1
          }
          Write-Host "‚úÖ SUCCESS! Server is online."

      - name: ‚è≥ Keep Alive (6 Hours)
        run: |
          Write-Host "Server is running. Connect at https://remotedesktop.google.com/access"
          while ($true) {
            Start-Sleep -Seconds 60
          }
