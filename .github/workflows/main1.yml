name: Windows RDP + OBS (Virtual Monitor Fix)

on: 
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'Paste WINDOWS Command (CMD) from Google Here'
        required: true
      pin:
        description: 'Set a 6-digit PIN'
        required: true
        default: '123456'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: üñ•Ô∏è Install Virtual Display Driver
        run: |
          # Download and install a virtual monitor driver so OBS has a screen to capture
          Invoke-WebRequest -Uri "https://github.com/itsmikethetech/Virtual-Display-Driver/releases/download/2.3/IddSampleDriver.zip" -OutFile "driver.zip"
          Expand-Archive -Path "driver.zip" -DestinationPath "C:\vdriver"
          # Install the certificate and driver
          Import-Certificate -FilePath "C:\vdriver\IddSampleDriver.cer" -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
          # Note: Driver installation on headless runners can be tricky, we'll proceed with CRD setup
          
      - name: üé• Install OBS Studio
        run: |
          choco install obs-studio -y --no-progress
          $WshShell = New-Object -comObject WScript.Shell
          $Shortcut = $WshShell.CreateShortcut("$Home\Desktop\OBS Studio.lnk")
          $Shortcut.TargetPath = "C:\Program Files\obs-studio\bin\64bit\obs64.exe"
          $Shortcut.Save()

      - name: üíø Install Chrome Remote Desktop
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process "msiexec.exe" -ArgumentList "/i crd.msi /quiet /norestart" -Wait

      - name: üõ†Ô∏è Registry Fix (No-Crash Mode)
        run: |
          $path = "HKLM:\SOFTWARE\Policies\Google\Chrome\RemoteAccessHost"
          if (!(Test-Path $path)) { New-Item -Path $path -Force }
          New-ItemProperty -Path $path -Name "RequireCurtain" -Value 0 -PropertyType DWORD -Force
          New-ItemProperty -Path $path -Name "RemoteAccessHostMatchUsername" -Value 0 -PropertyType DWORD -Force

      - name: üöÄ START REMOTE DESKTOP
        shell: cmd
        run: |
          :: Use the command from Google
          ${{ github.event.inputs.crd_code }} --pin=${{ github.event.inputs.pin }}

      - name: ‚è≥ Keep Alive
        run: |
          Write-Host "Connected! Open OBS and use 'Display Capture'."
          while ($true) { Start-Sleep -Seconds 60 }
