name: Ubuntu 22.04 Server

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Install Desktop Environment (XFCE4) & Audio
      run: |
        sudo apt-get update
        sudo apt-get install -y xfce4 xfce4-terminal pulseaudio alsa-utils
        sudo apt-get install -y python3-pygame  # Install Pygame dependencies system-wide

    - name: Install Chrome Remote Desktop
      run: |
        wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
        sudo dpkg --install chrome-remote-desktop_current_amd64.deb || sudo apt-get -f install -y

    - name: Set up Audio Dummy Driver (Fixes Pygame Crash)
      run: |
        echo "export SDL_AUDIODRIVER=dummy" >> ~/.bashrc
        echo "export SDL_AUDIODRIVER=dummy" >> ~/.profile

    - name: Setup Headless CRD (Paste your Code Below)
      env:
        # PASTE YOUR GOOGLE CRD CODE BELOW IN THE NEXT STEP
        CRD_CODE: ${{ secrets.CRD_CODE }} 
        PIN: 123456
      run: |
        # Create a user for the remote connection
        sudo useradd -m -s /bin/bash user
        sudo usermod -aG sudo user
        echo "user:$PIN" | sudo chpasswd
        
        # Run the CRD setup command as the new user
        sudo -u user bash -c "$CRD_CODE --pin=$PIN"

    - name: Keep Alive (6 Hours Max)
      run: |
        echo "Server is running! Connect via https://remotedesktop.google.com/access"
        sleep 21600
